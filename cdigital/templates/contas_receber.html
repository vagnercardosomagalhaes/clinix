{% load bootstrap4 %}
{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Contas a Receber</title>
    {% bootstrap_css %}
</head>
<body>
<div class="container mt-4">
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Fechar">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    {% endfor %}
{% endif %}    
    <h3>Cadastro de Contas a Receber</h3>

    <form method="post" action="{% url 'contas_receber' %}" class="mb-4">
        {% csrf_token %}
        <div class="form-group">
            <div class="col">
                <label for="vencimento">Vencimento:</label>
                <input type="date" name="vencimento" id="vencimento" style="width: 150px;" class="form-control" required>
            </div>
            <div class="col">
                <label for="cliente">Devedor:</label>
                <input list="lista_clientes" name="Cliente" placeholder="Nome do devedor" id="cliente" class="form-control" required>
                <datalist id="lista_clientes">
                    {% for c in clientes %}
                        <option value="{{ c }}">
                    {% endfor %}
                </datalist>
            </div>
            <div class="col">
                <label for="receita">Tipo de Receita:</label>
                <select name="receita" id="receita" class="form-control" required>
                    <option value="">Selecione a receita</option>
                    {% for r in receitas %}
                        <option value="{{ r.id }}">{{ r.codigo }} - {{ r.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label for="descricao">Descrição:</label>
                <input type="text" name="descricao" id="descricao" class="form-control" placeholder="Descrição">
            </div>
            <div class="col">
                <label for="conta_destino">Conta Destino:</label>
                <select name="conta_destino" id="conta_destino" class="form-control" required>
                    <option value="">Selecione a conta</option>
                    {% for banco in bancos %}
                        <option value="{{ banco.id }}">{{ banco.simbolo }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label for="valor">Valor R$:</label>
                <input type="number" step="0.01" name="valor" id="valor" placeholder="0,00" style="width: 150px;" class="form-control" required>
            </div>
            &nbsp;
            <div class="col">
                <button type="submit" class="btn btn-success" id="botao-gravar">Gravar</button>
                <a href="{% url 'index' %}" class="btn btn-warning">Retornar</a>
            </div>            
        </div>
    </form>

    <form method="get" class="form-inline mb-3">
        <label for="data_de" class="mr-2">Data de:</label>
        <input type="date" name="data_de" class="form-control mr-2" value="{{ data_de }}">
        <label for="data_ate" class="mr-2">Até:</label>
        <input type="date" name="data_ate" class="form-control mr-2" value="{{ data_ate }}">
        <button class="btn btn-primary">Filtrar</button>
    </form>

    <table class="table table-bordered table-striped">
        <thead class="thead-dark">
            <tr>
                <th>Data</th>
                <th>Devedor</th>
                <th>Descrição</th>
                <th>Valor</th>
                <th>Conta Destino</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
        {% for conta in contas %}
            <tr>
                <td>{{ conta.vencimento|date:"d/m/Y" }}</td>
                <td>{{ conta.cliente }}</td>
                <td>{{ conta.descricao }}</td>
                <td>R$ {{ conta.valor|floatformat:2 }}</td>
                <td>{% if conta.conta_destino %}{{ conta.conta_destino.simbolo }}{% else %}-{% endif %}</td>
                <td>
                    {% if conta.conta_destino %}
                    <a href="#" class="btn btn-sm btn-success receber-conta"
                    data-id="{{ conta.id }}"
                    data-vencimento="{{ conta.vencimento|date:'Y-m-d' }}"
                    data-receita="{{ conta.receita.id }}"
                    data-cliente="{{ conta.cliente }}"
                    data-descricao="{{ conta.descricao }}"
                    data-valor="{{ conta.valor|stringformat:'.2f' }}"
                    data-conta_destino="{{ conta.conta_destino.id }}">
                    Receber
                    </a>
                    {% else %}
                    <a href="#" class="btn btn-sm btn-success receber-conta"
                    data-id="{{ conta.id }}"
                    data-vencimento="{{ conta.vencimento|date:'Y-m-d' }}"
                    data-receita="{{ conta.receita.id }}"
                    data-cliente="{{ conta.cliente }}"
                    data-descricao="{{ conta.descricao }}"
                    data-valor="{{ conta.valor|stringformat:'.2f' }}"
                    data-conta_destino="">
                    Receber
                    </a>
                    {% endif %}

                    {% if conta.conta_destino %}
                    <a href="#" class="btn btn-sm btn-primary editar-conta"
                    data-id="{{ conta.id }}"
                    data-vencimento="{{ conta.vencimento|date:'Y-m-d' }}"
                    data-cliente="{{ conta.cliente }}"
                    data-receita="{{ conta.receita.id }}"
                    data-descricao="{{ conta.descricao }}"
                    data-valor="{{ conta.valor|stringformat:'.2f' }}"
                    data-conta_destino="{{ conta.conta_destino.id }}">
                    Editar
                    </a>
                    {% else %}
                    <a href="#" class="btn btn-sm btn-primary editar-conta"
                    data-id="{{ conta.id }}"
                    data-vencimento="{{ conta.vencimento|date:'Y-m-d' }}"
                    data-cliente="{{ conta.cliente }}"
                    data-receita="{{ conta.receita.id }}"
                    data-descricao="{{ conta.descricao }}"
                    data-valor="{{ conta.valor|stringformat:'.2f' }}"
                    data-conta_destino="{{ conta.conta_destino.id }}">
                    Editar
                    </a>
                    {% endif %}
                    <a href="#" class="btn btn-sm btn-danger">Excluir</a>
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="6">Nenhuma conta encontrada.</td></tr>
        {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3"><strong>Total do período:</strong></td>
                <td colspan="3"><strong>R$ {{ total|floatformat:2 }}</strong></td>
            </tr>
        </tfoot>
    </table>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  setTimeout(function() {
    let alert = document.querySelector('.alert');
    if (alert) {
      alert.classList.remove('show');
      alert.classList.add('fade');
    }
  }, 4000); // 4 segundos
</script>
<script>
document.querySelectorAll('.editar-conta').forEach(function(botao) {
    botao.addEventListener('click', function(e) {
        e.preventDefault();

        document.getElementById('vencimento').value = this.dataset.vencimento;
        document.getElementById('cliente').value = this.dataset.cliente;
        document.getElementById('receita').value = this.dataset.receita;
        document.getElementById('descricao').value = this.dataset.descricao;
        document.getElementById('valor').value = this.dataset.valor.replace(',', '.');
        document.getElementById('conta_destino').value = this.dataset.conta_destino;

        // Muda botão para "Alterar"
        const botaoGravar = document.getElementById('botao-gravar');
        botaoGravar.textContent = 'Alterar';
        botaoGravar.classList.remove('btn-success');
        botaoGravar.classList.add('btn-warning');

        // Adiciona ou atualiza o input hidden com o ID da conta
        let inputHidden = document.getElementById("id_conta");
        if (!inputHidden) {
            inputHidden = document.createElement("input");
            inputHidden.type = "hidden";
            inputHidden.name = "id";
            inputHidden.id = "id_conta";
            botaoGravar.closest("form").appendChild(inputHidden);
        }
        inputHidden.value = this.dataset.id;
    });
});
</script>
<script>
document.querySelectorAll('.receber-conta').forEach(function(botao) {
    botao.addEventListener('click', function(e) {
        e.preventDefault();

        if (confirm('Deseja realmente receber esta conta?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "receber_conta" %}';  // Criaremos essa rota na view

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            const fields = {
                'id': this.dataset.id,
                'vencimento': this.dataset.vencimento,
                'receita': this.dataset.receita,
                'cliente': this.dataset.cliente,
                'descricao': this.dataset.descricao,
                'valor': this.dataset.valor,
                'conta_destino': this.dataset.conta_destino,
                'csrfmiddlewaretoken': csrfToken
            };

            for (let key in fields) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            }

            document.body.appendChild(form);
            form.submit();
        }
    });
});
</script>
<!--
<script>
    document.querySelectorAll('.editar-conta').forEach(function(botao) {
        botao.addEventListener('click', function(e) {
            e.preventDefault();

            document.querySelector('input[name="vencimento"]').value = this.dataset.vencimento;
            document.querySelector('select[name="Cliente"]').value = this.dataset.cliente;
            document.querySelector('select[name="receita"]').value = this.dataset.receita;
            document.querySelector('input[name="descricao"]').value = this.dataset.descricao;
            document.querySelector('input[name="valor"]').value = this.dataset.valor.replace(',', '.');
            document.querySelector('select[name="conta_destino"]').value = this.dataset.conta_destino;

            // Altera texto do botão
            const botaoGravar = document.querySelector('form button[type="submit"]');
            botaoGravar.textContent = 'Alterar';
            botaoGravar.classList.remove('btn-success');
            botaoGravar.classList.add('btn-warning');

            // Cria input hidden com ID
            let inputHidden = document.getElementById("id_conta");
            if (!inputHidden) {
                inputHidden = document.createElement("input");
                inputHidden.type = "hidden";
                inputHidden.name = "id";
                inputHidden.id = "id_conta";
                botao.closest("form").appendChild(inputHidden);
            }
            inputHidden.value = this.dataset.id;
        });
    });
</script>
-->
</body>
</html>