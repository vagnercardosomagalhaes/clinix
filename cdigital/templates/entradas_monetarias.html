{% load bootstrap4 %}
{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Entradas Monetárias</title>
    {% bootstrap_css %}
</head>
<body>
<div class="container mt-4">
    {% if messages %}
        <div>
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Fechar">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endfor %}
        </div>
    {% endif %}
    <h3>Cadastro de Entradas Monetárias</h3>

    <form method="post" action="{% url 'entradas_monetarias' %}" class="mb-4">
        {% csrf_token %}
        <div class="form-group">
            <div class="col">
                <label for="vencimento" class="mr-2">Data:</label>
                <input type="date" name="vencimento" style="width: 150px;" class="form-control" required>
            </div>
            <div class="col">
                <label for="cliente" class="mr-2">Origem:</label>
                <select name="Cliente" class="form-control" required>
                    <option value="">Selecione ou digite</option>
                    {% for c in clientes %}
                        <option value="{{ c }}">{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label for="receita" class="mr-2">Tipo de Receita:</label>
                <select name="receita" class="form-control" required>
                    <option value="">Selecione a receita</option>
                    {% for r in receitas %}
                        <option value="{{ r.id }}">{{ r.codigo }} - {{ r.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label for="descricao" class="mr-2">Descrição:</label>
                <input type="text" name="descricao" class="form-control" placeholder="Descrição">
            </div>

            <div class="col">
                <label for="conta">Conta Destino:</label>
                <select name="conta" id="conta" class="form-control" required>
                    <option value="">Selecione a conta</option>
                    {% for banco in bancos %}
                        <option value="{{ banco.id }}">{{ banco.simbolo }}</option>
                    {% endfor %}
                </select>
            </div>  

            <div class="col">
                <label for="valor" class="mr-2">Valor R$:</label>
                <input type="number" step="0.01" name="valor" style="width: 150px;" class="form-control" placeholder="0,00" required>
            </div>
            &nbsp;
            <div class="col">
                <button class="btn btn-success" id="botao-gravar" type="submit">Gravar</button>
                <a href="{% url 'index' %}" class="btn btn-warning">Retornar</a>
            </div>
        </div>
    </form>

    <form method="get" class="form-inline mb-3">
        <label for="data_de" class="mr-2">Data de:</label>
        <input type="date" name="data_de" class="form-control mr-2" value="{{ data_de }}">
        <label for="data_ate" class="mr-2">Até:</label>
        <input type="date" name="data_ate" class="form-control mr-2" value="{{ data_ate }}">
        <label for="filtro_cliente" class="mr-2">Devedor:</label>
        <input type="text" name="filtro_cliente" class="form-control mr-2" style="width: 450px;" list="lista_clientes" value="{{ filtro_cliente }}">
        <datalist id="lista_clientes">
            {% for c in clientes %}
                <option value="{{ c }}">
            {% endfor %}
        </datalist>
        <button class="btn btn-primary">Filtrar</button>
    </form>

    <table class="table table-bordered table-striped">
        <thead class="thead-dark">
            <tr>
                <th>Data</th>
                <th>Origem</th>
                <th>Descrição</th>
                <th>Conta Destino</th>
                <th>Valor</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
        {% for entrada in entradas %}
            <tr>
                <td>{{ entrada.vencimento|date:"d/m/Y" }}</td>
                <td>{{ entrada.cliente }}</td>
                <td>{{ entrada.descricao }}</td>
                <td>{% if entrada.conta_destino %}{{ entrada.conta_destino.simbolo }}{% else %}-{% endif %}</td>
                <td>R$ {{ entrada.valor|floatformat:2 }}</td>
                <td>
                    <!--<a href="#" class="btn btn-sm btn-success">Confirmar</a>-->
                    <a href="#" class="btn btn-sm btn-primary editar-entrada"
                    data-id="{{ entrada.id }}"
                    data-vencimento="{{ entrada.vencimento|date:'Y-m-d' }}"
                    data-cliente="{{ entrada.cliente }}"
                    data-receita="{{ entrada.receita.id }}"
                    data-descricao="{{ entrada.descricao }}"
                    data-conta_destino="{{ entrada.conta_destino.id }}"
                    data-valor="{{ entrada.valor|stringformat:'.2f' }}">
                    Editar
                    </a>
                    <a href="#" class="btn btn-sm btn-danger">Excluir</a>
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="5">Nenhuma entrada encontrada.</td></tr>
        {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3"><strong>Total do período:</strong></td>
                <td colspan="2"><strong>R$ {{ total|floatformat:2 }}</strong></td>
            </tr>
        </tfoot>
    </table>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.querySelectorAll('.editar-entrada').forEach(function(botao) {
    botao.addEventListener('click', function(e) {
        e.preventDefault();

        // Preencher os campos
        document.querySelector('input[name="vencimento"]').value = this.dataset.vencimento;
        document.querySelector('select[name="Cliente"]').value = this.dataset.cliente;
        document.querySelector('select[name="receita"]').value = this.dataset.receita;
        document.querySelector('input[name="descricao"]').value = this.dataset.descricao;
        document.querySelector('select[name="conta"]').value = this.dataset.conta_destino;
        document.querySelector('input[name="valor"]').value = this.dataset.valor.replace(',', '.');

        // Atualizar o botão
        const botaoGravar = document.getElementById('botao-gravar');
        botaoGravar.textContent = 'Alterar';
        botaoGravar.classList.remove('btn-success');
        botaoGravar.classList.add('btn-warning');

        // Adicionar campo hidden com ID
        let inputHidden = document.getElementById("id_entrada");
        if (!inputHidden) {
            inputHidden = document.createElement("input");
            inputHidden.type = "hidden";
            inputHidden.name = "id";
            inputHidden.id = "id_entrada";
            botaoGravar.closest("form").appendChild(inputHidden);
        }
        inputHidden.value = this.dataset.id;
    });
});
</script>
</body>
</html>